<!DOCTYPE html>
<meta charset="utf-8">
<style>
  rect {
    display: inline-block;
    fill: gray;
    stroke: black;
    stroke-width: 1;
    fill-opacity: 0.1;
    stroke-opacity: 0.9;
  }

  button {
    margin-top: 20px;
    line-height: 30px;
    font-weight: bold;
    padding: 0 20px;
    background: white;
    border: dotted;
  }

  button:hover {
    background: gray;
  }
</style>

<head>
  <meta charset="utf-8">
  <title>Textbox Test</title>
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>

  <script>
    var w = 500;
    var h = 200;

    var svg = d3.select("body").append("svg")
      .attr("width", w)
      .attr("height", h);

    function renderBoxes(json) {

      var box = svg.selectAll(".box")
        .data(json);

      var boxEnter = box.enter()
        .append("g")
        .attr("class", "box")
        .attr("transform", function(d) {
          return "translate(" + d.x + "," + d.y + ")"
        });

      boxEnter.append("rect")
        .attr("class", "rect")
        .attr("width", 40)
        .attr("height", 30)
        .attr("id", function(d) {
          return "rect_" + d.id;
        })
        .attr("dependsOn", function(d) {return d.dependsOn});

      boxEnter.append("text")
        .style("fill", "black")
        .style("font-family", "calibri")
        .style("font-size", "15px")
        .attr("dy", "1em")
        .text(function(d) {
          return d.label;
        });

      var rectangle = d3.select("#rect_1")[0];

      var boxLine = box.enter()
        .append("line")
        .style("stroke", "black")
        .attr("x1", function(d) {
          return d.x;
        })
        .attr("y1", function(d) {
          return d.y;
        })
        .attr("x2", function(d) {
          if (d.dependsOn != undefined) {
            var rectangle = d3.select("#rect_" + d.dependsOn)[0];
            return rectangle[0].__data__.x
          } else {
            return 0;
          }
        })
        .attr("y2", function(d) {
          if (d.dependsOn != undefined) {
            var rectangle = d3.select("#rect_" + d.dependsOn)[0];
            return rectangle[0].__data__.y
          } else {
            return 0;
          }
        });


      console.log(rectangle[0].__data__);
      json.forEach(function(boxData) {

        //   var box = svg.selectAll(".box")
        //     .data(json, function(d) {
        //       return d.id
        //     });


        //
        //   var boxEnter = box.enter()
        //     .append("g")
        //     .attr("class", "box")
        //     .attr("transform", "translate(" + boxData.x + "," + boxData.y + ")");
        // //
        // boxEnter.append("rect")
        //   .attr("id", boxData.id)
        //   .attr("class", "rect")
        //   .attr("width", 40)
        //   .attr("height", 30);
        //
        // boxEnter.append("text")
        //   .attr("id", boxData.id)
        //   .style("fill", "black")
        //   .style("font-family", "calibri")
        //   .style("font-size", "15px")
        //   .attr("dy", "1em")
        //   .text(function(d) {
        //     return boxData.label;
        //   });
        //
        // drawLine(svg, boxData.x, boxData.y, 100, 150);

        //                console.log(d3.select(svg.select(boxData.x)));
      })


      //   var box = svg.selectAll(".box")
      //     .data(json, function(d) {
      //       return d.id
      //     });
      //
      //   var boxEnter = box.enter()
      //     .append("g")
      //     .each(function(d) {
      //       //console.log("enter", d)
      //     })
      //     .attr("class", "box")
      //     .attr("transform", function(d) {
      //       return "translate(" + d.x + "," + d.y + ")"
      //     });
      //
      //   boxEnter.append("rect")
      //     .attr("class", "rect")
      //     .attr("width", 40)
      //     .attr("height", 30);
      //
      //   boxEnter.append("text")
      //     .style("fill", "black")
      //     .style("font-family", "calibri")
      //     .style("font-size", "15px")
      //     .attr("dy", "1em")
      //     .text(function(d) {
      //       return d.label;
      //     });
      //
      //     console.log();
      //
      //     drawLine(svg, boxEnter.x, boxEnter.y, 100, 150);
      //
      //   box.exit()
      //     .each(function(d) {
      //       console.log("remove", d)
      //     })
      //     .remove();
    }

    function readAndRender() {
      d3.json("data.json", function(error, json) {
        if (error) return console.warn(error);

        renderBoxes(json);
      });
    }

    function drawLine(drawArea, x1, y1, x2, y2) {
      drawArea.append("line")
        .style("stroke", "black")
        .attr("x1", x1)
        .attr("y1", y1)
        .attr("x2", x2)
        .attr("y2", y2);
    }

    // function addText(text, label) {
    //   text.append("text")
    //     .style("fill", "black")
    //     .style("font-family", "calibri")
    //     .style("font-size", "15px")
    //     .attr("dy", "1em");
    // }
    //   boxEnter.append("text")
    //     .style("fill", "black")
    //     .style("font-family", "calibri")
    //     .style("font-size", "15px")
    //     .attr("dy", "1em")
    //     .text(function(d) {
    //       return d.label;
    //     });

    //  .attr("id", function(d) { return d.id; })

    readAndRender();

    var button = document.createElement("button");
    button.innerHTML = "Reload file";

    var body = document.getElementsByTagName("body")[0];
    body.appendChild(button);

    button.addEventListener("click", function() {
      readAndRender();
    });
  </script>
</body>

</html>
